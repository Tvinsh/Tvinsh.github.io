<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>tomato</title>
	<meta name="viewport" content="user-scalable=no,width=718">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="robots" content="all">
    <meta name="googlebot" content="all">
    <meta name="baiduspider" content="all">
    <meta name="format-detection" content="telephone=no">
	<link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="rss">
	<link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.2.0/styles/github.min.css">
	<script src="//cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script>
	<link rel="stylesheet" href="/css/i.css">
	<link rel="stylesheet" href="/css/cmts.css">
	<link rel="stylesheet" href="/css/arc.css">
</head>
<body>
	<nav class="nav">
	<a href="/" class="true home" ><img src="/image/me.jpeg">tomato</a>
	<a href="/archives/" title="连续不断的奇迹" class="false" ><img src="/image/design/nichijou.svg">归档</a>
	<a href="/tags/" title="{1+1>2}" class="false eltag" ><img src="/image/design/tag.svg">tag</a>
	<a href="/tags/demo" title="{1+1>2}" class="false"><img src="/image/design/code.svg">demo</a>
	<a href="/tags/life" class="false"><img src="/image/design/feel.svg">生活</a>
	<!-- <a href="#!home" ><img src="/image/design/vsco.svg">VSCO</a> -->
	<a href="/tags/photo" class="false"><img src="/image/design/photo.svg">photo</a>
	<a href="/about" class="false"><img src="/image/design/link.svg">about</a>
</nav>
	<div id="m">
		<div id="S">
	<div class="I">
		<form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="键入内容启用google搜索"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
	</div>
	<ul id="Sl" class="h">
		<li>
			<a>
				<h3>键入内容启用google搜索</h3>
			</a>
		</li>
	</ul>
</div>

		
		
		<article class="p">
	<div class="p-text">
		<p><p>总结起点个人中心头像上传的实现，兼容ie8。</p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>利用form表单，监听input的change事件，促发表单提交，将表单提交到一个隐藏的iframe中，监听iframe的load事件，当图片上传成功后，通过load事件取到图片的地址，将此图片显示在裁剪框中，这样就实现了图片的预览，然后根据裁剪框中的选择框，得到裁剪图片的top，left以及width和height，通过这四个值以及上传的图片，后台就可以截取图片并将截取的图片返回给前端，从而实现图片的无刷新裁剪上传。</p>
<h3 id="html部分"><a href="#html部分" class="headerlink" title="html部分"></a>html部分</h3><p>这里只介绍一些必须的dom结构，业务需要的其他结构可以自行添加。</p>
<blockquote>
<p>1.无刷新上传表单，即选择图片后上传供裁剪的表单，基本结构如下</p>
</blockquote>
<pre><code class="html">    &lt;form method=&quot;post&quot; enctype=&quot;multipart/form-data&quot; action=&quot;&quot; target=&quot;iframeAvatar&quot;&gt;
        &lt;input type=&quot;file&quot; id=&quot;fileAvatar&quot; name=&quot;image&quot; class=&quot;clip&quot; accept=&quot;image/png, image/jpeg, image/gif, image/jpg&quot;&gt;
    &lt;/form&gt;
</code></pre>
<p>这个表单结构比较简单，form里面嵌套一个 <code>type=file</code> 的input，其中设置 form 的 enctype 属性 <code>enctype=&quot;multipart/form-data&quot;</code>,enctype 属性规定在发送到服务器之前应该如何对表单数据进行编码,文件类型需使用<code>multipart/form-data</code> 属性值。form元素新增target属性，其值指向页面内隐藏的一个 iframe 元素的id。 input 元素如上设置 accept 属性，不能直接设置成 <code>accept=&quot;image/*&quot;</code>,这样在chrome下会有性能问题，选择图片时会非常慢。</p>
<blockquote>
<p>2.隐藏的 iframe 元素</p>
</blockquote>
<pre><code class="html">&lt;iframe src=&quot;javascript:;&quot; id=&quot;iframeAvatar&quot; name=&quot;iframeAvatar&quot; class=&quot;clip dn&quot;&gt;&lt;/iframe&gt;
</code></pre>
<p>在 form 元素同级增加一个 iframe 元素，设置其隐藏<code>display:none;</code>，并且将其 id 设为和 form 元素的target 同值。</p>
<blockquote>
<p>3.入库表单，即裁剪完成后上传头像的表单，基本结构如下：</p>
</blockquote>
<pre><code class="html">    &lt;form id=&quot;setAvatarForm&quot; action=&quot;&quot; method=&quot;post&quot;&gt;
        &lt;!-- 上传成功后显示头像，以及更换头像入口 --&gt;
        &lt;div id=&quot;avatarXChoose&quot; class=&quot;avatar-x-choose&quot;&gt;
            &lt;img class=&quot;avatar-show&quot; src=&quot;&lt;%= data.headUrl %&gt;&quot; alt=&quot;&lt;%= data.user.nickName %&gt;的头像&quot;&gt;
            &lt;div&gt;
                &lt;label class=&quot;ui-button&quot; for=&quot;fileAvatar&quot; id=&quot;elLabelforup&quot; role=&quot;button&quot; tabindex=&quot;-1&quot; data-eid=&quot;qd_M141&quot; &gt;本地上传&lt;/label&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        &lt;!-- 头像裁剪 --&gt;
        &lt;div id=&quot;avatarXCrop&quot; class=&quot;avatar-x-crop pr dn&quot;&gt;
            &lt;input type=&quot;hidden&quot; id=&quot;iptCropLeft&quot; name=&quot;left&quot; value=&quot;0&quot;&gt;
            &lt;input type=&quot;hidden&quot; id=&quot;iptCropTop&quot; name=&quot;top&quot; value=&quot;0&quot;&gt;
            &lt;input type=&quot;hidden&quot; id=&quot;iptCropWidth&quot; name=&quot;width&quot; value=&quot;120&quot;&gt;
            &lt;input type=&quot;hidden&quot; id=&quot;iptCropHeight&quot; name=&quot;height&quot; value=&quot;120&quot;&gt;
            &lt;div id=&quot;avatarCrop&quot; class=&quot;avatar-crop&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;avatar-preview&quot;&gt;
                &lt;h3&gt;预览头像&lt;/h3&gt;
                &lt;div class=&quot;avatar-big&quot;&gt;
                    &lt;div id=&quot;avatarCropL&quot; class=&quot;avatar-big-img&quot;&gt;&lt;img&gt;&lt;/div&gt;
                    &lt;div class=&quot;avatar-preview-size&quot;&gt;
                        &lt;div&gt;大尺寸&lt;/div&gt;
                        &lt;div&gt;120x120&lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                &lt;div class=&quot;avatar-middle&quot;&gt;
                    &lt;div id=&quot;avatarCropM&quot; class=&quot;avatar-middle-img&quot;&gt;&lt;img&gt;&lt;/div&gt;
                    &lt;div class=&quot;avatar-preview-size&quot;&gt;
                        &lt;div&gt;中尺寸&lt;/div&gt;
                        &lt;div&gt;60x60&lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                &lt;div class=&quot;avatar-small&quot;&gt;
                    &lt;div id=&quot;avatarCropS&quot; class=&quot;avatar-small-img&quot;&gt;&lt;img&gt;&lt;/div&gt;
                    &lt;div class=&quot;avatar-preview-size&quot;&gt;
                        &lt;div&gt;小尺寸&lt;/div&gt;
                        &lt;div&gt;30x30&lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            &lt;div&gt;
                &lt;label for=&quot;avatarSubmit&quot; class=&quot;ui-button&quot; id=&quot;elUserAvatar&quot;&gt;保存头像&lt;/label&gt;
                &lt;a href=&quot;javascript:;&quot; id=&quot;btnUploadCancel&quot; class=&quot;ui-button ui-button-default&quot;&gt;取消&lt;/a&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        &lt;input type=&quot;submit&quot; id=&quot;avatarSubmit&quot; class=&quot;clip&quot;&gt;
    &lt;/form&gt;
</code></pre>
<p>入库表单也是无刷新上传表单的同级元素，其 action 指向头像提交的后台接口，表单内主要分为3个部分</p>
<pre><code>1. 头像设置首页，即显示目前头像即上传按钮
2. 裁剪框
3. 隐藏的提交input
</code></pre><p>其中头像设置首页的本地上传label 关联到无刷新上传表单的input，所以点击就会弹出图片选择框，同理，隐藏的提交input 的id <code>id=&quot;avatarSubmit&quot;</code>需要和裁剪框内的 保存头像的label <code>for=&quot;avatarSubmit&quot;</code> 的for属性一致,这样点击保存头像就会促发入库表单的提交。<br>裁剪框内设置 4 个隐藏的input元素，同时设置name 分别为top， left， width， height， 后台在拿到上传的图片后，根据这4个值就可以正确的裁剪好图片并且返回给我们。</p>
<h3 id="css-部分"><a href="#css-部分" class="headerlink" title="css 部分"></a>css 部分</h3><p>原生<code>&lt;input type=&quot;file&quot;&gt;</code> 按钮样式不好自定义，我们可以让<code>label</code>元素和<code>file</code>控件关联，即让<code>label</code>的<code>for</code>属性和<code>input</code>的<code>id</code>属性值相同，然后设置<code>input</code>的样式为<code>clip:rect(0 0 0 0);</code>,裁剪的top,right,bottom,left都为0，此时<code>input</code>就隐藏了，label元素的样式就比较好定义了，而且label元素可以在form表单的外面，同样可以促发表单的提交。</p>
</p>
	</div>
</article>
	</div>
</body>
<script>
	hljs.initHighlightingOnLoad();
</script>
</html>